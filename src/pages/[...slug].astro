---
// @pages/[...slug].astro

import { getCollection, render } from 'astro:content'
import Base from '@layouts/core/Base.astro'
import { components } from '@scripts/components/components'
import { _isChildRoute } from '@scripts/utils/is-child-route'
import SignatureV3 from '@layouts/templates/SignatureV3.astro'
import Year from '@layouts/templates/Year.astro'

export async function getStaticPaths() {
	const collections = ['pages', 'signatures', 'year'] as const

	const all = await Promise.all(collections.map((c) => getCollection(c)))
	const map = Object.fromEntries(collections.map((c, i) => [c, all[i]]))

	return collections.flatMap((collection) => {
		return map[collection]
			.filter((entry) => {
				if (entry.data.draft) return false
				if (collection === 'pages' && entry.id === 'pages/contact')
					return false
				return true
			})
			.map((entry) => {
				let slug = entry.id

				if (collection === 'pages') {
					slug =
						entry.id === 'pages/home'
							? '/'
							: entry.id.replace(/^pages\//, '')
				}

				if (collection === 'signatures') {
					slug = entry.id.replace(/^signatures\//, 'signatures/')
				}

				if (collection === 'year') {
					slug = entry.id.replace(/^year\//, 'year/')
				}

				return {
					params: { slug },
					props: { entry },
				}
			})
	})
}

const { entry } = Astro.props
const { Content, headings } = await render(entry)
const { pathname } = Astro.url

const isSignature = _isChildRoute(pathname, 'signatures')
const isYear = _isChildRoute(pathname, 'year')
---

<Base data={entry.data}>
	{
		isSignature ? (
			<SignatureV3 entry={entry} data={entry.data} Content={Content} />
		) : isYear ? (
			<Year
				entry={entry}
				data={entry.data}
				Content={Content}
				headings={headings}
			/>
		) : (
			<Content components={components} />
		)
	}
</Base>
